"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { formatDistanceToNowStrict } from "date-fns";
import { tr } from "date-fns/locale";
import { IconHeartFilled, IconMessageCircle, IconRepeat, IconAt, IconUserFilled } from "@tabler/icons-react";

import LeftSidebar from "@/components/LeftSidebar";
import RightSidebar from "@/components/RightSidebar";
import MobileHeader from "@/components/mobile/MobileHeader";
import MobileBottomNav from "@/components/mobile/MobileBottomNav";
import GlobalHeader from "@/components/GlobalHeader";
import VerificationBadge from "@/components/VerificationBadge";
import PostItem from "@/components/PostItem";

interface Actor {
    id: string;
    nickname: string;
    fullName: string | null;
    profileImage: string | null;
    verificationTier: 'NONE' | 'GREEN' | 'GOLD' | 'GRAY';
    hasBlueTick: boolean;
}

interface Notification {
    id: string;
    type: 'LIKE' | 'REPLY' | 'MENTION' | 'QUOTE' | 'FOLLOW';
    read: boolean;
    createdAt: string;
    actor: Actor;
    post?: {
        id: string;
        content: string;
        createdAt: string;
        imageUrl?: string | null;
        mediaUrl?: string | null;
        parentPostId?: string | null;
        isAnonymous?: boolean;
        linkPreview?: any;
        author: {
            nickname: string;
            fullName?: string | null;
            profileImage?: string | null;
            verificationTier?: 'NONE' | 'GREEN' | 'GOLD' | 'GRAY';
            hasBlueTick?: boolean;
        };
        _count: {
            likes: number;
            replies: number;
            quotes: number;
        };
    } | null;
    recipientId: string;
}

interface GroupedNotification {
    id: string;
    type: 'LIKE' | 'REPLY' | 'MENTION' | 'QUOTE' | 'FOLLOW';
    read: boolean;
    createdAt: string;
    actors: Actor[];
    post?: {
        id: string;
        content: string;
        createdAt: string;
        imageUrl?: string | null;
        mediaUrl?: string | null;
        parentPostId?: string | null;
        isAnonymous?: boolean;
        linkPreview?: any;
        author: {
            nickname: string;
            fullName?: string | null;
            profileImage?: string | null;
            verificationTier?: 'NONE' | 'GREEN' | 'GOLD' | 'GRAY';
            hasBlueTick?: boolean;
        };
        _count: {
            likes: number;
            replies: number;
            quotes: number;
        };
    } | null;
}

function groupNotifications(notifications: Notification[]): GroupedNotification[] {
    const grouped: GroupedNotification[] = [];
    const likeGroups = new Map<string, number>(); // postId -> index in grouped

    for (const notif of notifications) {
        if (notif.type === 'LIKE' && notif.post) {
            if (likeGroups.has(notif.post.id)) {
                const index = likeGroups.get(notif.post.id)!;
                // Add actor if not already present (optimization: check id)
                const existing = grouped[index];
                if (!existing.actors.some(a => a.id === notif.actor.id)) {
                    existing.actors.push(notif.actor);
                }
                // Update timestamp to latest
                if (new Date(notif.createdAt) > new Date(existing.createdAt)) {
                    existing.createdAt = notif.createdAt;
                    existing.id = notif.id; // Update ID to latest
                }
            } else {
                const newGroup: GroupedNotification = {
                    id: notif.id,
                    type: 'LIKE',
                    read: notif.read,
                    createdAt: notif.createdAt,
                    actors: [notif.actor],
                    post: notif.post,
                };
                const newIndex = grouped.push(newGroup) - 1;
                likeGroups.set(notif.post.id, newIndex);
            }
        } else {
            // Non-like or no-post notifications are not grouped
            grouped.push({
                id: notif.id,
                type: notif.type,
                read: notif.read,
                createdAt: notif.createdAt,
                actors: [notif.actor],
                post: notif.post,
            });
        }
    }

    // Sort by createdAt desc just in case
    return grouped.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
}

export default function Notifications() {
    const router = useRouter();
    const [notifications, setNotifications] = useState<GroupedNotification[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchNotifications = async () => {
            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    router.push("/");
                    return;
                }

                const res = await fetch("/api/notifications?page=1", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (res.ok) {
                    const data = await res.json();
                    setNotifications(groupNotifications(data.notifications));
                }
            } catch (error) {
                console.error("Error fetching notifications:", error);
            } finally {
                setLoading(false);
            }
        };

        fetchNotifications();
    }, [router]);

    const formatDate = (dateString: string) => {
        return formatDistanceToNowStrict(new Date(dateString), { addSuffix: true, locale: tr });
    };

    return (
        <>
            <MobileHeader />
            <div className="hidden lg:flex justify-center w-full">
                <div className="flex w-full max-w-[1310px]">
                    <header className="left-nav flex-shrink-0 w-[88px] xl:w-[275px] h-screen sticky top-0 overflow-y-auto z-10">
                        <div className="h-full p-0 m-0 border-0">
                            <LeftSidebar />
                        </div>
                    </header>

                    <main className="content flex flex-1 min-h-screen">
                        <section className="timeline flex-1 w-full lg:max-w-[600px] flex flex-col items-stretch lg:border-l lg:border-r border-theme-border">
                            {/* Sticky Header */}
                            <GlobalHeader title="Bildirimler" subtitle="Tehlike çanlarını görüntüle" />

                            {/* Notifications List */}
                            <div className="divide-y divide-[#2f3336]">
                                {loading ? (
                                    <div className="flex justify-center p-8">
                                        <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-orange-500"></div>
                                    </div>
                                ) : notifications.length === 0 ? (
                                    <div className="p-8 text-center text-gray-500">Henüz bildirim yok.</div>
                                ) : (
                                    notifications.map((group) => {
                                        const isUnread = !group.read;

                                        // Determine styling and content based on type
                                        let icon = null;
                                        let actionText = "";
                                        let contentBody = null;

                                        switch (group.type) {
                                            case 'LIKE':
                                                icon = <IconHeartFilled className="w-7 h-7 text-[#F91880]" />;
                                                actionText = group.post?.parentPostId ? 'yanıtını beğendi' : 'gönderini beğendi';
                                                contentBody = group.post?.content ? (
                                                    <div className="text-[15px] text-theme-subtitle mt-0.5 max-w-full truncate">
                                                        {group.post.content}
                                                    </div>
                                                ) : null;
                                                break;
                                            case 'FOLLOW':
                                                icon = <IconUserFilled className="w-7 h-7 text-[#1d9bf0]" />;
                                                actionText = 'seni takip etti';
                                                break;
                                            case 'REPLY':
                                                icon = <IconMessageCircle className="w-7 h-7 text-[#1d9bf0]" />;
                                                actionText = 'sana yanıt verdi';
                                                contentBody = group.post ? (
                                                    <div className="mt-2 border border-theme-border rounded-xl overflow-hidden">
                                                        <PostItem
                                                            post={{
                                                                id: group.post.id,
                                                                content: group.post.content,
                                                                createdAt: group.post.createdAt,
                                                                parentPostId: group.post.parentPostId || undefined,
                                                                linkPreview: group.post.linkPreview,
                                                                author: {
                                                                    id: group.post.author.nickname,
                                                                    nickname: group.post.author.nickname,
                                                                    fullName: group.post.author.fullName || undefined,
                                                                    profileImage: group.post.author.profileImage || undefined,
                                                                    verificationTier: group.post.author.verificationTier || 'NONE',
                                                                    hasBlueTick: group.post.author.hasBlueTick || false,
                                                                },
                                                                _count: {
                                                                    likes: group.post._count.likes || 0,
                                                                    comments: group.post._count.replies || 0,
                                                                    quotes: group.post._count.quotes || 0,
                                                                },
                                                                mediaUrl: group.post.mediaUrl || undefined,
                                                                imageUrl: group.post.imageUrl || undefined,
                                                                isLiked: false,
                                                                isBookmarked: false,
                                                                isCommented: false,
                                                                isQuoted: false,
                                                                quoteCount: group.post._count.quotes || 0
                                                            }}
                                                            isFirst={false}
                                                            showThreadLine={false}
                                                            showThreadFooter={false}
                                                            className="border-b-0"
                                                        />
                                                    </div>
                                                ) : null;
                                                break;
                                            case 'QUOTE':
                                                icon = <IconRepeat className="w-7 h-7 text-[#00ba7c]" />;
                                                actionText = 'gönderini alıntıladı';
                                                contentBody = group.post ? (
                                                    <div className="mt-2 border border-theme-border rounded-xl overflow-hidden">
                                                        <PostItem
                                                            post={{
                                                                id: group.post.id,
                                                                content: group.post.content,
                                                                createdAt: group.post.createdAt,
                                                                parentPostId: group.post.parentPostId || undefined,
                                                                linkPreview: group.post.linkPreview,
                                                                author: {
                                                                    id: group.post.author.nickname,
                                                                    nickname: group.post.author.nickname,
                                                                    fullName: group.post.author.fullName || undefined,
                                                                    profileImage: group.post.author.profileImage || undefined,
                                                                    verificationTier: group.post.author.verificationTier || 'NONE',
                                                                    hasBlueTick: group.post.author.hasBlueTick || false,
                                                                },
                                                                _count: {
                                                                    likes: group.post._count.likes || 0,
                                                                    comments: group.post._count.replies || 0,
                                                                    quotes: group.post._count.quotes || 0,
                                                                },
                                                                mediaUrl: group.post.mediaUrl || undefined,
                                                                imageUrl: group.post.imageUrl || undefined,
                                                                isLiked: false,
                                                                isBookmarked: false,
                                                                isCommented: false,
                                                                isQuoted: false,
                                                                quoteCount: group.post._count.quotes || 0
                                                            }}
                                                            isFirst={false}
                                                            showThreadLine={false}
                                                            showThreadFooter={false}
                                                            className="border-b-0"
                                                        />
                                                    </div>
                                                ) : null;
                                                break;
                                            case 'MENTION':
                                                icon = <IconAt className="w-7 h-7 text-[#1d9bf0]" />;
                                                actionText = 'senden bahsetti';
                                                contentBody = group.post ? (
                                                    <div className="mt-2 border border-theme-border rounded-xl overflow-hidden">
                                                        <PostItem
                                                            post={{
                                                                id: group.post.id,
                                                                content: group.post.content,
                                                                createdAt: group.post.createdAt,
                                                                parentPostId: group.post.parentPostId || undefined,
                                                                linkPreview: group.post.linkPreview,
                                                                author: {
                                                                    id: group.post.author.nickname,
                                                                    nickname: group.post.author.nickname,
                                                                    fullName: group.post.author.fullName || undefined,
                                                                    profileImage: group.post.author.profileImage || undefined,
                                                                    verificationTier: group.post.author.verificationTier || 'NONE',
                                                                    hasBlueTick: group.post.author.hasBlueTick || false,
                                                                },
                                                                _count: {
                                                                    likes: group.post._count.likes || 0,
                                                                    comments: group.post._count.replies || 0,
                                                                    quotes: group.post._count.quotes || 0,
                                                                },
                                                                mediaUrl: group.post.mediaUrl || undefined,
                                                                imageUrl: group.post.imageUrl || undefined,
                                                                isLiked: false,
                                                                isBookmarked: false,
                                                                isCommented: false,
                                                                isQuoted: false,
                                                                quoteCount: group.post._count.quotes || 0
                                                            }}
                                                            isFirst={false}
                                                            showThreadLine={false}
                                                            showThreadFooter={false}
                                                            className="border-b-0"
                                                        />
                                                    </div>
                                                ) : null;
                                                break;
                                        }

                                        return (
                                            <div
                                                key={group.id}
                                                onClick={async () => {
                                                    // Mark as read locally
                                                    if (isUnread) {
                                                        const newNotifications = notifications.map(n =>
                                                            n.id === group.id ? { ...n, read: true } : n
                                                        );
                                                        setNotifications(newNotifications);

                                                        try {
                                                            const token = localStorage.getItem("token");
                                                            if (token) {
                                                                await fetch("/api/notifications/read", {
                                                                    method: "PUT",
                                                                    headers: {
                                                                        "Content-Type": "application/json",
                                                                        "Authorization": `Bearer ${token}`
                                                                    },
                                                                    body: JSON.stringify({ notificationIds: [group.id] })
                                                                });
                                                            }
                                                        } catch (error) {
                                                            console.error("Failed to mark as read", error);
                                                        }
                                                    }

                                                    // Navigate
                                                    if (group.type === 'FOLLOW') {
                                                        router.push(`/${group.actors[0].nickname}`);
                                                    } else if (group.post) {
                                                        router.push(`/${group.post.author?.nickname || 'user'}/status/${group.post.id}`);
                                                    } else {
                                                        router.push(`/${group.actors[0].nickname}`);
                                                    }
                                                }}
                                                className={`p-4 hover:bg-white/5 transition-colors cursor-pointer border-b border-theme-border ${isUnread ? 'bg-[#080808]' : ''}`}
                                            >
                                                <div className="flex items-start gap-3">
                                                    {/* Left Icon */}
                                                    <div className="flex-shrink-0">
                                                        {icon}
                                                    </div>

                                                    {/* Main Content */}
                                                    <div className="flex-1 min-w-0">
                                                        {group.actors.length === 1 ? (
                                                            /* Single Actor: Everything on one line */
                                                            <div className="flex items-center gap-2">
                                                                {/* Profile Photo */}
                                                                <div className="flex-shrink-0">
                                                                    <div className="w-7 h-7 rounded-full border-2 border-black bg-gray-800">
                                                                        {group.actors[0].profileImage ? (
                                                                            <img src={group.actors[0].profileImage} alt={group.actors[0].nickname} className="w-full h-full object-cover rounded-full" />
                                                                        ) : (
                                                                            <div className="w-full h-full flex items-center justify-center text-xs font-bold text-white bg-gray-700">
                                                                                {group.actors[0].nickname[0].toUpperCase()}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>

                                                                {/* Name + Action Text */}
                                                                <div className="flex-1 text-[15px] leading-5 text-theme-text min-w-0">
                                                                    <span className="font-bold hover:underline">
                                                                        {group.actors[0].nickname}
                                                                    </span>
                                                                    <VerificationBadge
                                                                        tier={group.actors[0].verificationTier}
                                                                        hasBlueTick={group.actors[0].hasBlueTick}
                                                                        username={group.actors[0].nickname}
                                                                        className="ml-0.5 inline-block align-bottom"
                                                                        style={{ width: '18px', height: '18px', marginBottom: '1px' }}
                                                                    />
                                                                    <span className="text-theme-subtitle"> {actionText}</span>
                                                                </div>

                                                                {/* Date */}
                                                                <span className="text-sm text-theme-subtitle whitespace-nowrap flex-shrink-0">
                                                                    {formatDate(group.createdAt)}
                                                                </span>
                                                            </div>
                                                        ) : (
                                                            /* Multiple Actors: Two lines */
                                                            <>
                                                                {/* First Row: Avatars + Date */}
                                                                <div className="flex items-center gap-2 mb-0.5">
                                                                    {/* Profile Photos */}
                                                                    <div className="flex items-center -space-x-2 flex-shrink-0">
                                                                        {group.actors.slice(0, 8).map((actor, i) => (
                                                                            <div key={i} className="w-7 h-7 rounded-full border-2 border-black bg-gray-800">
                                                                                {actor.profileImage ? (
                                                                                    <img src={actor.profileImage} alt={actor.nickname} className="w-full h-full object-cover rounded-full" />
                                                                                ) : (
                                                                                    <div className="w-full h-full flex items-center justify-center text-xs font-bold text-white bg-gray-700">
                                                                                        {actor.nickname[0].toUpperCase()}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                        {group.actors.length > 8 && (
                                                                            <div className="w-7 h-7 rounded-full border-2 border-black bg-gray-700 flex items-center justify-center text-xs text-white">
                                                                                +{group.actors.length - 8}
                                                                            </div>
                                                                        )}
                                                                    </div>

                                                                    {/* Spacer */}
                                                                    <div className="flex-1"></div>

                                                                    {/* Date */}
                                                                    <span className="text-sm text-theme-subtitle whitespace-nowrap flex-shrink-0">
                                                                        {formatDate(group.createdAt)}
                                                                    </span>
                                                                </div>

                                                                {/* Second Row: Name + Action Text */}
                                                                <div className="text-[15px] leading-5 text-theme-text">
                                                                    <span className="font-bold hover:underline">
                                                                        {group.actors[0].nickname}
                                                                    </span>
                                                                    <VerificationBadge
                                                                        tier={group.actors[0].verificationTier}
                                                                        hasBlueTick={group.actors[0].hasBlueTick}
                                                                        username={group.actors[0].nickname}
                                                                        className="ml-0.5 inline-block align-bottom"
                                                                        style={{ width: '18px', height: '18px', marginBottom: '1px' }}
                                                                    />
                                                                    <span>
                                                                        {" ve diğer "}
                                                                        <span className="font-bold">{group.actors.length - 1} kişi</span>
                                                                    </span>
                                                                    <span className="text-theme-subtitle"> {actionText}</span>
                                                                </div>
                                                            </>
                                                        )}

                                                        {/* Post Content (Always on separate row) */}
                                                        {contentBody && (
                                                            <div className="mt-1">
                                                                {contentBody}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </section>

                        {/* Right Sidebar */}
                        <aside className="right-side hidden xl:block w-[350px] flex-shrink-0 ml-[10px] pt-6">
                            <div className="sticky top-6 max-h-[calc(100vh-3rem)] overflow-y-auto">
                                <RightSidebar />
                            </div>
                        </aside>
                    </main>
                </div>
            </div>

            {/* Mobile Layout */}
            <div className="lg:hidden flex flex-col min-h-screen">
                <main className="content flex-1 pt-14 pb-16">
                    <section className="timeline w-full flex flex-col items-stretch">
                        <GlobalHeader title="Bildirimler" subtitle="Etkileşimlerini görüntüle" className="top-14" />
                        <div className="divide-y divide-[#2f3336]">
                            {loading ? (
                                <div className="flex justify-center p-8">
                                    <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-orange-500"></div>
                                </div>
                            ) : notifications.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">Henüz bildirim yok.</div>
                            ) : (
                                notifications.map((group) => {
                                    const isUnread = !group.read;

                                    // Determine styling and content based on type
                                    let icon = null;
                                    let actionText = "";
                                    let contentBody = null;

                                    switch (group.type) {
                                        case 'LIKE':
                                            icon = <IconHeartFilled className="w-7 h-7 text-[#F91880]" />;
                                            actionText = group.post?.parentPostId ? 'yanıtını beğendi' : 'gönderini beğendi';
                                            contentBody = group.post?.content ? (
                                                <div className="text-[15px] text-theme-subtitle mt-0.5 max-w-full truncate">
                                                    {group.post.content}
                                                </div>
                                            ) : null;
                                            break;
                                        case 'FOLLOW':
                                            icon = <IconUserFilled className="w-7 h-7 text-[#1d9bf0]" />;
                                            actionText = 'seni takip etti';
                                            break;
                                        case 'REPLY':
                                            icon = <IconMessageCircle className="w-7 h-7 text-[#1d9bf0]" />;
                                            actionText = 'sana yanıt verdi';
                                            contentBody = group.post ? (
                                                <div className="mt-2 border border-theme-border rounded-xl overflow-hidden">
                                                    <PostItem
                                                        post={{
                                                            id: group.post.id,
                                                            content: group.post.content,
                                                            createdAt: group.post.createdAt,
                                                            parentPostId: group.post.parentPostId || undefined,
                                                            linkPreview: group.post.linkPreview,
                                                            author: {
                                                                id: group.post.author.nickname,
                                                                nickname: group.post.author.nickname,
                                                                fullName: group.post.author.fullName || undefined,
                                                                profileImage: group.post.author.profileImage || undefined,
                                                                verificationTier: group.post.author.verificationTier || 'NONE',
                                                                hasBlueTick: group.post.author.hasBlueTick || false,
                                                            },
                                                            _count: {
                                                                likes: group.post._count.likes || 0,
                                                                comments: group.post._count.replies || 0,
                                                                quotes: group.post._count.quotes || 0,
                                                            },
                                                            mediaUrl: group.post.mediaUrl || undefined,
                                                            imageUrl: group.post.imageUrl || undefined,
                                                            isLiked: false,
                                                            isBookmarked: false,
                                                            isCommented: false,
                                                            isQuoted: false,
                                                            quoteCount: group.post._count.quotes || 0
                                                        }}
                                                        isFirst={false}
                                                        showThreadLine={false}
                                                        showThreadFooter={false}
                                                        className="border-b-0"
                                                    />
                                                </div>
                                            ) : null;
                                            break;
                                        case 'QUOTE':
                                            icon = <IconRepeat className="w-7 h-7 text-[#00ba7c]" />;
                                            actionText = 'gönderini alıntıladı';
                                            contentBody = group.post ? (
                                                <div className="mt-2 border border-theme-border rounded-xl overflow-hidden">
                                                    <PostItem
                                                        post={{
                                                            id: group.post.id,
                                                            content: group.post.content,
                                                            createdAt: group.post.createdAt,
                                                            parentPostId: group.post.parentPostId || undefined,
                                                            linkPreview: group.post.linkPreview,
                                                            author: {
                                                                id: group.post.author.nickname,
                                                                nickname: group.post.author.nickname,
                                                                fullName: group.post.author.fullName || undefined,
                                                                profileImage: group.post.author.profileImage || undefined,
                                                                verificationTier: group.post.author.verificationTier || 'NONE',
                                                                hasBlueTick: group.post.author.hasBlueTick || false,
                                                            },
                                                            _count: {
                                                                likes: group.post._count.likes || 0,
                                                                comments: group.post._count.replies || 0,
                                                                quotes: group.post._count.quotes || 0,
                                                            },
                                                            mediaUrl: group.post.mediaUrl || undefined,
                                                            imageUrl: group.post.imageUrl || undefined,
                                                            isLiked: false,
                                                            isBookmarked: false,
                                                            isCommented: false,
                                                            isQuoted: false,
                                                            quoteCount: group.post._count.quotes || 0
                                                        }}
                                                        isFirst={false}
                                                        showThreadLine={false}
                                                        showThreadFooter={false}
                                                        className="border-b-0"
                                                    />
                                                </div>
                                            ) : null;
                                            break;
                                        case 'MENTION':
                                            icon = <IconAt className="w-7 h-7 text-[#1d9bf0]" />;
                                            actionText = 'senden bahsetti';
                                            contentBody = group.post ? (
                                                <div className="mt-2 border border-theme-border rounded-xl overflow-hidden">
                                                    <PostItem
                                                        post={{
                                                            id: group.post.id,
                                                            content: group.post.content,
                                                            createdAt: group.post.createdAt,
                                                            parentPostId: group.post.parentPostId || undefined,
                                                            linkPreview: group.post.linkPreview,
                                                            author: {
                                                                id: group.post.author.nickname,
                                                                nickname: group.post.author.nickname,
                                                                fullName: group.post.author.fullName || undefined,
                                                                profileImage: group.post.author.profileImage || undefined,
                                                                verificationTier: group.post.author.verificationTier || 'NONE',
                                                                hasBlueTick: group.post.author.hasBlueTick || false,
                                                            },
                                                            _count: {
                                                                likes: group.post._count.likes || 0,
                                                                comments: group.post._count.replies || 0,
                                                                quotes: group.post._count.quotes || 0,
                                                            },
                                                            mediaUrl: group.post.mediaUrl || undefined,
                                                            imageUrl: group.post.imageUrl || undefined,
                                                            isLiked: false,
                                                            isBookmarked: false,
                                                            isCommented: false,
                                                            isQuoted: false,
                                                            quoteCount: group.post._count.quotes || 0
                                                        }}
                                                        isFirst={false}
                                                        showThreadLine={false}
                                                        showThreadFooter={false}
                                                        className="border-b-0"
                                                    />
                                                </div>
                                            ) : null;
                                            break;
                                    }

                                    return (
                                        <div
                                            key={group.id}
                                            onClick={async () => {
                                                // Mark as read locally
                                                if (isUnread) {
                                                    const newNotifications = notifications.map(n =>
                                                        n.id === group.id ? { ...n, read: true } : n
                                                    );
                                                    setNotifications(newNotifications);

                                                    try {
                                                        const token = localStorage.getItem("token");
                                                        if (token) {
                                                            await fetch("/api/notifications/read", {
                                                                method: "PUT",
                                                                headers: {
                                                                    "Content-Type": "application/json",
                                                                    "Authorization": `Bearer ${token}`
                                                                },
                                                                body: JSON.stringify({ notificationIds: [group.id] })
                                                            });
                                                        }
                                                    } catch (error) {
                                                        console.error("Failed to mark as read", error);
                                                    }
                                                }

                                                // Navigate
                                                if (group.type === 'FOLLOW') {
                                                    router.push(`/${group.actors[0].nickname}`);
                                                } else if (group.post) {
                                                    router.push(`/${group.post.author?.nickname || 'user'}/status/${group.post.id}`);
                                                } else {
                                                    router.push(`/${group.actors[0].nickname}`);
                                                }
                                            }}
                                            className={`p-4 hover:bg-white/5 transition-colors cursor-pointer border-b border-theme-border ${isUnread ? 'bg-[#080808]' : ''}`}
                                        >
                                            <div className="flex items-start gap-3">
                                                {/* Left Icon */}
                                                <div className="flex-shrink-0">
                                                    {icon}
                                                </div>

                                                {/* Main Content */}
                                                <div className="flex-1 min-w-0">
                                                    {group.actors.length === 1 ? (
                                                        /* Single Actor: Everything on one line */
                                                        <div className="flex items-center gap-2">
                                                            {/* Profile Photo */}
                                                            <div className="flex-shrink-0">
                                                                <div className="w-7 h-7 rounded-full border-2 border-black bg-gray-800">
                                                                    {group.actors[0].profileImage ? (
                                                                        <img src={group.actors[0].profileImage} alt={group.actors[0].nickname} className="w-full h-full object-cover rounded-full" />
                                                                    ) : (
                                                                        <div className="w-full h-full flex items-center justify-center text-xs font-bold text-white bg-gray-700">
                                                                            {group.actors[0].nickname[0].toUpperCase()}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>

                                                            {/* Name + Action Text */}
                                                            <div className="flex-1 text-[15px] leading-5 text-theme-text min-w-0">
                                                                <span className="font-bold hover:underline">
                                                                    {group.actors[0].nickname}
                                                                </span>
                                                                <VerificationBadge
                                                                    tier={group.actors[0].verificationTier}
                                                                    hasBlueTick={group.actors[0].hasBlueTick}
                                                                    username={group.actors[0].nickname}
                                                                    className="ml-0.5 inline-block align-bottom"
                                                                    style={{ width: '18px', height: '18px', marginBottom: '1px' }}
                                                                />
                                                                <span className="text-theme-subtitle"> {actionText}</span>
                                                            </div>

                                                            {/* Date */}
                                                            <span className="text-sm text-theme-subtitle whitespace-nowrap flex-shrink-0">
                                                                {formatDate(group.createdAt)}
                                                            </span>
                                                        </div>
                                                    ) : (
                                                        /* Multiple Actors: Two lines */
                                                        <>
                                                            {/* First Row: Avatars + Date */}
                                                            <div className="flex items-center gap-2 mb-0.5">
                                                                {/* Profile Photos */}
                                                                <div className="flex items-center -space-x-2 flex-shrink-0">
                                                                    {group.actors.slice(0, 8).map((actor, i) => (
                                                                        <div key={i} className="w-7 h-7 rounded-full border-2 border-black bg-gray-800">
                                                                            {actor.profileImage ? (
                                                                                <img src={actor.profileImage} alt={actor.nickname} className="w-full h-full object-cover rounded-full" />
                                                                            ) : (
                                                                                <div className="w-full h-full flex items-center justify-center text-xs font-bold text-white bg-gray-700">
                                                                                    {actor.nickname[0].toUpperCase()}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                    {group.actors.length > 8 && (
                                                                        <div className="w-7 h-7 rounded-full border-2 border-black bg-gray-700 flex items-center justify-center text-xs text-white">
                                                                            +{group.actors.length - 8}
                                                                        </div>
                                                                    )}
                                                                </div>

                                                                {/* Spacer */}
                                                                <div className="flex-1"></div>

                                                                {/* Date */}
                                                                <span className="text-sm text-theme-subtitle whitespace-nowrap flex-shrink-0">
                                                                    {formatDate(group.createdAt)}
                                                                </span>
                                                            </div>

                                                            {/* Second Row: Name + Action Text */}
                                                            <div className="text-[15px] leading-5 text-theme-text">
                                                                <span className="font-bold hover:underline">
                                                                    {group.actors[0].nickname}
                                                                </span>
                                                                <VerificationBadge
                                                                    tier={group.actors[0].verificationTier}
                                                                    hasBlueTick={group.actors[0].hasBlueTick}
                                                                    username={group.actors[0].nickname}
                                                                    className="ml-0.5 inline-block align-bottom"
                                                                    style={{ width: '18px', height: '18px', marginBottom: '1px' }}
                                                                />
                                                                <span>
                                                                    {" ve diğer "}
                                                                    <span className="font-bold">{group.actors.length - 1} kişi</span>
                                                                </span>
                                                                <span className="text-theme-subtitle"> {actionText}</span>
                                                            </div>
                                                        </>
                                                    )}

                                                    {/* Post Content (Always on separate row) */}
                                                    {contentBody && (
                                                        <div className="mt-1">
                                                            {contentBody}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </section>

                    <aside className="right-side hidden lg:block w-[350px] flex-shrink-0 ml-[10px] pt-6">
                        <div className="sticky top-6 max-h-[calc(100vh-3rem)] overflow-y-auto">
                            <RightSidebar />
                        </div>
                    </aside>
                </main>
            </div>

            <MobileBottomNav />
        </>
    );
}
