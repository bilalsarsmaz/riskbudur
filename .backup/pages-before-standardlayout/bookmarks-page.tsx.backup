"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import LeftSidebar from "@/components/LeftSidebar";
import RightSidebar from "@/components/RightSidebar";
import MobileHeader from "@/components/mobile/MobileHeader";
import MobileBottomNav from "@/components/mobile/MobileBottomNav";
import PostList from "@/components/PostList";
import { fetchApi } from "@/lib/api";
import { EnrichedPost } from "@/types/post";


import GlobalHeader from "@/components/GlobalHeader";


export default function BookmarksPage() {
  const router = useRouter();
  const [posts, setPosts] = useState<EnrichedPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!token) {
      router.push("/");
      return;
    }

    // Token'dan userId çıkar
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      if (payload.userId) {
        setCurrentUserId(payload.userId);
      }
    } catch (e) {
      console.error("Token parse hatası:", e);
    }

    const fetchBookmarks = async () => {
      try {
        const data = await fetchApi("/bookmarks");
        setPosts(data.posts || []);
      } catch (err) {
        console.error("Bookmarks yüklenirken hata:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchBookmarks();
  }, [router]);

  const handlePostDeleted = (post: EnrichedPost) => {
    setPosts(posts.filter(p => p.id !== post.id));
  };

  // Loading content
  const LoadingContent = () => (
    <div className="flex items-center justify-center py-20">
      <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-orange-500"></div>
    </div>
  );

  return (
    <>
      <MobileHeader />

      <div className="hidden lg:flex justify-center w-full">
        <div className="flex w-full max-w-[1310px]">
          <header className="left-nav flex-shrink-0 w-[88px] xl:w-[275px] h-screen sticky top-0 overflow-y-auto z-10">
            <div className="h-full p-0 m-0 border-0">
              <LeftSidebar />
            </div>
          </header>

          <main className="content flex flex-1 min-h-screen">
            <section className="timeline flex-1 w-full lg:max-w-[600px] flex flex-col items-stretch lg:border-l lg:border-r border-theme-border">
              <GlobalHeader title="Çivilenenler" subtitle="Çaktığın gönderiler" />

              {loading ? (
                <LoadingContent />
              ) : posts.length > 0 ? (
                <PostList
                  posts={posts}
                  currentUserId={currentUserId || undefined}
                  onPostDeleted={handlePostDeleted}
                />
              ) : (
                <div className="p-8 text-center">
                  <p style={{ color: '#6e767d' }}>Henüz kaydettiğin gönderi yok.</p>
                </div>
              )}
            </section>

            {/* Sağ Sidebar */}
            <aside className="right-side hidden lg:block w-[350px] flex-shrink-0 ml-[10px] pt-6">
              <div className="sticky top-6 max-h-[calc(100vh-3rem)] overflow-y-auto">
                <RightSidebar />
              </div>
            </aside>
          </main >
        </div >
      </div >

      {/* Mobil Layout */}
      < div className="lg:hidden flex flex-col min-h-screen" >
        <main className="content flex-1 pt-14 pb-16">
          <section className="timeline w-full flex flex-col items-stretch">
            <GlobalHeader title="Yer İşaretleri" subtitle="Kaydettiğin gönderiler" className="top-14" />

            {loading ? (
              <LoadingContent />
            ) : posts.length > 0 ? (
              <PostList
                posts={posts}
                currentUserId={currentUserId || undefined}
                onPostDeleted={handlePostDeleted}
              />
            ) : (
              <div className="p-8 text-center">
                <p style={{ color: '#6e767d' }}>Henüz kaydettiğin gönderi yok.</p>
              </div>
            )}
          </section>
        </main>
      </div >

      {/* Mobil Bottom Nav */}
      < MobileBottomNav />
    </>
  );
}
