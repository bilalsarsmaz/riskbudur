generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                @id @default(cuid())
  email                 String                @unique
  password              String?
  nickname              String                @unique
  bio                   String?
  website               String?
  role                  Role                  @default(USER)
  isBanned              Boolean               @default(false)
  hasBlueTick           Boolean               @default(false)
  coverImage            String?               @default("/rb-cover.png")
  fullName              String?
  profileImage          String?
  verificationTier      VerificationTier      @default(NONE)
  createdAt             DateTime?             @default(now())
  updatedAt             DateTime?             @updatedAt
  isSetupComplete       Boolean               @default(false)
  birthday              DateTime?
  gender                String?
  lastSeen              DateTime?             @default(now())
  isApproved            Boolean               @default(false)
  announcements         Announcement[]
  bookmarks             Bookmark[]
  comments              Comment[]
  following             Follow[]              @relation("following")
  followers             Follow[]              @relation("followers")
  likes                 Like[]
  sentNotifications     Notification[]        @relation("sentNotifications")
  receivedNotifications Notification[]        @relation("receivedNotifications")
  posts                 Post[]
  quotes                Quote[]
  verificationRequests  VerificationRequest[]
  visited               ProfileVisit[]        @relation("visited")
  visitors              ProfileVisit[]        @relation("visitor")

  // Messaging relations
  conversations ConversationParticipant[]
  sentMessages  Message[]
  pollVotes     PollVote[]
}

model Conversation {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())

  participants ConversationParticipant[]
  messages     Message[]

  @@index([lastMessageAt])
}

model ConversationParticipant {
  id             String   @id @default(cuid())
  userId         String
  conversationId String
  joinedAt       DateTime @default(now())
  lastReadAt     DateTime @default(now()) // For unread count

  user         User         @relation(fields: [userId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String   @id @default(cuid())
  content        String
  imageUrl       String?
  createdAt      DateTime @default(now())
  conversationId String
  senderId       String
  isRead         Boolean  @default(false)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model ProfileVisit {
  id        String   @id @default(cuid())
  visitorId String
  visitedId String
  visitedAt DateTime @default(now())

  visitor User @relation("visitor", fields: [visitorId], references: [id], onDelete: Cascade)
  visited User @relation("visited", fields: [visitedId], references: [id], onDelete: Cascade)

  @@unique([visitorId, visitedId])
  @@index([visitedId, visitedAt])
}

model Post {
  content       String
  mediaUrl      String?
  imageUrl      String?
  isAnonymous   Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  authorId      String
  id            BigInt         @id @default(autoincrement())
  linkPreview   Json?
  parentPostId  BigInt?
  threadRootId  BigInt?
  bookmarks     Bookmark[]
  comments      Comment[]
  likes         Like[]
  notifications Notification[]
  author        User           @relation(fields: [authorId], references: [id])
  parentPost    Post?          @relation("PostReplies", fields: [parentPostId], references: [id])
  replies       Post[]         @relation("PostReplies")
  threadRoot    Post?          @relation("ThreadPosts", fields: [threadRootId], references: [id])
  threadPosts   Post[]         @relation("ThreadPosts")
  quotes        Quote[]
  hashtags      Hashtag[]      @relation("HashtagToPost")
  poll          Poll?

  @@index([parentPostId])
  @@index([threadRootId])
  @@index([authorId, createdAt])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  postId    BigInt
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  postId    BigInt
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

model Comment {
  id          String   @id @default(cuid())
  content     String
  authorId    String
  postId      BigInt
  isAnonymous Boolean  @default(false)
  createdAt   DateTime @default(now())
  author      User     @relation(fields: [authorId], references: [id])
  post        Post     @relation(fields: [postId], references: [id])
}

model Quote {
  id           String   @id @default(cuid())
  content      String
  createdAt    DateTime @default(now())
  authorId     String
  isAnonymous  Boolean  @default(false)
  quotedPostId BigInt
  author       User     @relation(fields: [authorId], references: [id])
  quotedPost   Post     @relation(fields: [quotedPostId], references: [id])
}

model Hashtag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  posts     Post[]   @relation("HashtagToPost")
}

model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("following", fields: [followerId], references: [id])
  following   User     @relation("followers", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

model Notification {
  id          String           @id @default(cuid())
  type        NotificationType
  read        Boolean          @default(false)
  recipientId String
  actorId     String
  postId      BigInt?
  createdAt   DateTime         @default(now())
  actor       User             @relation("sentNotifications", fields: [actorId], references: [id])
  post        Post?            @relation(fields: [postId], references: [id])
  recipient   User             @relation("receivedNotifications", fields: [recipientId], references: [id])

  @@index([recipientId])
  @@index([createdAt])
}

model Announcement {
  id        String   @id @default(cuid())
  content   String
  isActive  Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id])
}

model VerificationRequest {
  id               String   @id @default(cuid())
  userId           String
  fullName         String
  category         String
  description      String
  identityImageUrl String?
  status           String   @default("PENDING")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
}

enum VerificationTier {
  NONE
  GREEN
  GOLD
  GRAY
}

enum Role {
  USER
  MODERATOR
  LEAD
  ADMIN
  ROOTADMIN
}

enum NotificationType {
  LIKE
  REPLY
  MENTION
  QUOTE
  FOLLOW
  SYSTEM
}

model Poll {
  id        String       @id @default(cuid())
  postId    BigInt       @unique
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  options   PollOption[]
  votes     PollVote[]
  expiresAt DateTime
  createdAt DateTime     @default(now())
}

model PollOption {
  id        String     @id @default(cuid())
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text      String
  votes     PollVote[]
  voteCount Int        @default(0)
}

model PollVote {
  id        String     @id @default(cuid())
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId  String
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([pollId, userId])
}
